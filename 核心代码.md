# SQL Agent 核心技术文档

## 一、系统架构

基于 **LangChain Agent Framework** 构建，采用 **ReAct（Reasoning + Acting）** 范式实现自然语言到 SQL 的智能转换。

```
用户自然语言 → LLM意图理解 → Agent工具调用链 → SQL执行 → LLM结果总结
```

---

## 二、LLM 集成

### 2.1 模型配置

采用 **通义千问 Qwen3-Max** 作为核心推理引擎：

```python
from langchain_community.chat_models import ChatTongyi

self.llm = ChatTongyi(
    model_name="qwen3-max",      # 千问旗舰模型
    temperature=0                 # 确定性输出，保证SQL生成稳定性
)
```

### 2.2 多阶段 LLM 调用

| 阶段 | 功能 | 说明 |
|------|------|------|
| 意图理解 | 提取用户期望的数据行数 | 精确提取"前N条"/"全部"意图 |
| SQL生成 | Agent 工具调用链 | 自动生成并执行 SQL |
| 回答生成 | 最终自然语言回复 | 流式输出 |

---

## 三、Agent 核心实现

### 3.1 System Prompt 工程

动态构建包含数据库 Schema 的系统提示词，杜绝幻觉：

```python
from langchain_community.agent_toolkits import create_sql_agent
from langchain_core.messages import SystemMessage

@staticmethod
def _create_default_system_prompt(schema_info: str, default_limit: int) -> str:
    """动态构建 System Prompt，注入真实数据库结构"""
    return f"""你是一名严谨的 MySQL 数据分析助手。

【权威 Schema（严禁臆造表/字段）】
{schema_info}

【规则】
- 只能调用工具 `sql_db_query`，一次只提交一条 SELECT 查询
- 只读：禁止 INSERT / UPDATE / DELETE / ALTER / DROP / CREATE 等写操作
- 除非用户明确要求更多，否则默认最多返回 {default_limit} 行
- 如果工具返回 Error，请修正 SQL 后再重试
- 最多尝试 10 次；若仍失败，向用户说明原因
- 最终回答必须使用中文
"""
```

### 3.2 Agent 执行器创建

```python
# 创建 SQL Agent
self.agent_executor = create_sql_agent(
    llm=self.llm,
    db=self.db,                           # SQLDatabase 实例
    agent_type="openai-tools",            # OpenAI Function Calling 风格
    max_iterations=10,                    # 最大推理步数
    verbose=True,
    system_message=SystemMessage(content=system_prompt)
)
```

### 3.3 查询执行

```python
def query(self, question: str) -> Dict[str, Any]:
    """执行自然语言查询"""
    
    # 使用 LLM 智能判断用户想要的数据行数
    self._effective_limit = extract_limit_with_llm(question, self.llm)
    
    # Agent 执行
    result = self.agent_executor.invoke(
        {"input": question},              # 用户问题作为 User Prompt
        config={"callbacks": callbacks}
    )
    
    return {
        "success": True,
        "question": question,
        "answer": result.get("output", ""),
        "sql": captured_sql
    }
```

---

## 四、智能意图理解

### 4.1 LLM 提取行数限制

```python
def extract_limit_with_llm(question: str, llm) -> int:
    """
    使用 LLM 智能判断用户想要的数据行数
    
    返回值：
    - 具体数字：用户明确指定（如"前10个"、"Top 5"）
    - LIMIT_ALL：用户想要全部数据（如"所有"、"列出xxx"）
    - 20：默认值
    """
    prompt = f"""分析用户的问题，判断用户想要返回多少条数据。

用户问题："{question}"

判断规则：
1. 如果用户明确指定了数量（如"前10个"、"Top 5"），返回该数字
2. 如果用户想要全部数据（如"列出所有"、"全部"），返回 -1
3. 如果用户没有明确意图，返回 20

只返回一个数字。"""

    response = llm.invoke([HumanMessage(content=prompt)])
    result = int(response.content.strip())
    
    if result == -1:
        return LIMIT_ALL
    return result if result > 0 else 20
```





*基于 LangChain Agent + 通义千问 Qwen3-Max*
