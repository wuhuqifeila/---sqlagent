# SQL Agent Streamlit Cloud 部署指南

## ✅ 已完成的步骤


##如果需要本地启动
# 步骤1：进入项目目录
cd "D:\Bobo\梧桐杯2"

# 步骤2：激活conda环境
conda activate bobo

# 步骤3：启动应用
python -m streamlit run sqlagent\web_ui.py

### 第1步：迁移MySQL到云端 ✅
- ✅ 已注册SQLPub云数据库
- ✅ 云端数据库信息：
  - 主机：`mysql2.sqlpub.com:3307`
  - 数据库名：`wutongbei`
  - 用户：`bobo11`
  - 密码：`ls0OmCgVJIXHwawv`
- ✅ 数据已成功导入（8个表，共341,998条数据）

### 第2步：修改Streamlit代码 ✅
- ✅ 更新了 `sqlagent/config.py`，支持从环境变量和Streamlit secrets读取配置
- ✅ 添加了云端数据库连接信息
- ✅ 创建了 `.streamlit/secrets.toml` 配置文件
- ✅ 创建了 `.gitignore` 文件（防止敏感信息泄露）

### 第3步：本地测试 ✅
- ✅ 应用已在本地成功运行
- ✅ 可以正常连接到云端MySQL数据库
- ✅ 访问地址：http://localhost:8501

---

## 📋 接下来需要做的步骤

### 第4步：GitHub准备

1. **创建公开仓库**
   ```bash
   # 如果还没有初始化Git
   git init
   
   # 添加所有文件（.gitignore会自动排除敏感文件）
   git add .
   
   # 提交代码
   git commit -m "Initial commit: SQL Agent with cloud database"
   
   # 在GitHub上创建新仓库，然后关联
   git remote add origin https://github.com/你的用户名/你的仓库名.git
   git branch -M main
   git push -u origin main
   ```

2. **确认不要提交的文件**
   - ❌ `.env` 文件
   - ❌ `.streamlit/secrets.toml` 文件
   - ❌ 数据库密码或API密钥
   - ✅ 已在 `.gitignore` 中配置

### 第5步：Streamlit Cloud部署

1. **访问 Streamlit Cloud**
   - 网址：https://share.streamlit.io/
   - 使用GitHub账号登录

2. **创建新应用**
   - 点击 "New app"
   - 选择你的GitHub仓库
   - 主文件路径：`sqlagent/web_ui.py`
   - Python版本：3.10 或更高

3. **配置Secrets（重要！）**
   点击 "Advanced settings" > "Secrets"，复制以下内容：
   
   ```toml
   # Qwen API 配置
   DASHSCOPE_API_KEY = "sk-58552a72301c44f795e1d7d4fad83f2a"
   
   # 云端数据库配置
   DB_USER = "bobo11"
   DB_PASSWORD = "ls0OmCgVJIXHwawv"
   DB_HOST = "mysql2.sqlpub.com"
   DB_PORT = "3307"
   DB_NAME = "wutongbei"
   
   # LLM 配置
   MODEL_NAME = "qwen-max"
   TEMPERATURE = "0"
   STREAMING = "False"
   
   # Agent 配置
   MAX_ITERATIONS = "5"
   VERBOSE = "True"
   AGENT_TYPE = "openai-tools"
   
   # 安全配置
   DEFAULT_LIMIT = "5"
   ENABLE_HUMAN_IN_LOOP = "False"
   ```

4. **部署**
   - 点击 "Deploy"
   - 等待构建完成（通常需要2-5分钟）

### 第6步：获取分享链接

1. **自动生成的URL**
   - 格式：`https://你的用户名-你的仓库名.streamlit.app`
   - 可以直接分享这个链接

2. **可选：设置密码保护**
   - 在Streamlit Cloud的应用设置中
   - 添加访问密码

---

## 📁 项目文件结构

```
梧桐杯2/
├── sqlagent/                    # 主应用代码
│   ├── web_ui.py               # Streamlit界面（主入口）
│   ├── config.py               # 配置文件（已更新为云端数据库）
│   ├── agent.py                # SQL Agent核心逻辑
│   ├── requirements.txt        # Python依赖
│   └── ...
├── database_create/            # 数据迁移脚本
│   ├── migrate_to_cloud.py    # 云端迁移脚本（已执行）
│   └── ...
├── .streamlit/
│   └── secrets.toml           # 本地secrets配置（不提交到Git）
├── .gitignore                 # Git忽略文件配置
└── 部署指南.md                 # 本文件
```

---

## 🔧 本地开发

### 启动应用
```bash
# 激活conda环境
conda activate bobo

# 运行应用
python -m streamlit run sqlagent\web_ui.py
```

### 访问应用
- 本地地址：http://localhost:8501

---

## ⚠️ 注意事项

1. **安全性**
   - 不要将 `.env` 或 `.streamlit/secrets.toml` 提交到Git
   - 在Streamlit Cloud中配置secrets，而不是硬编码在代码中

2. **数据库连接**
   - 云端数据库已包含所有数据（8个表，341,998条记录）
   - 如需更新数据，重新运行 `database_create/migrate_to_cloud.py`

3. **API密钥**
   - Qwen API密钥已配置在secrets中
   - 如需更换，修改 `DASHSCOPE_API_KEY` 值

---

## 📞 常见问题

### Q: 本地测试连接不上云端数据库？
A: 检查网络连接和数据库配置是否正确。

### Q: Streamlit Cloud部署失败？
A: 
1. 检查 `requirements.txt` 是否包含所有依赖
2. 确认secrets配置正确
3. 查看部署日志中的错误信息

### Q: 如何更新已部署的应用？
A: 只需要将更新推送到GitHub仓库，Streamlit Cloud会自动重新部署。

---

## 🎉 部署成功标志

当你看到以下内容时，说明部署成功：
- ✅ Streamlit应用正常启动
- ✅ 可以在浏览器中访问
- ✅ 能够连接到云端数据库
- ✅ SQL查询功能正常工作

---

## 📝 数据库表信息

已导入的8个表：
1. `managers` - 管理者信息（500行）
2. `clients` - 客户信息（15,000行）
3. `products` - 产品信息（200行）
4. `counterparties` - 交易对手信息（100行）
5. `portfolios` - 投资组合信息（20,000行）
6. `transactions` - 交易记录（100,000行）
7. `holdings` - 持仓信息（106,198行）
8. `risk_metrics` - 风险指标（100,000行）

总计：341,998条数据记录

